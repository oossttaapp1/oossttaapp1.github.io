<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ĞĞ¾Ğ²Ğ°Ñ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ°</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Lora:ital,wght@0,500;0,600;1,400&family=Syne:wght@800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
<style>
:root {
  --bg: #000000;
  --bg2: #080808;
  --surface: #101010;
  --surface2: #181818;
  --border: #1e1e1e;
  --border2: #2e2e2e;
  --accent: #c4b5fd;
  --accent-glow: rgba(196,181,253,0.1);
  --accent2: #a5d8ff;
  --accent3: #ffd6a5;
  --text: #dedede;
  --text-muted: #585858;
  --text-dim: #2e2e2e;
  --node-group1: #a78bfa;
  --node-group2: #818cf8;
  --node-group3: #7dd3fc;
  --node-group4: #c4b5fd;
  --node-group5: #93c5fd;
  --node-tag: #1e1e1e;
  --link-color: rgba(167,139,250,0.12);
  --link-hover: rgba(255,255,255,0.55);
  --panel: #0a0a0a;
  --panel-border: #1e1e1e;
  --shadow: 0 8px 40px rgba(0,0,0,0.9);
  --shadow-sm: 0 2px 16px rgba(0,0,0,0.7);
  --tag-bg: #141414;
  --tag-text: #666666;
}

[data-theme="light"] {
  --bg: #fafafa;
  --bg2: #f0f0f0;
  --surface: #ffffff;
  --surface2: #f5f5f5;
  --border: #e0e0e0;
  --border2: #cccccc;
  --accent: #7c6af7;
  --accent-glow: rgba(124,106,247,0.1);
  --accent2: #4fa8d8;
  --accent3: #d4900a;
  --text: #1a1a1a;
  --text-muted: #888888;
  --text-dim: #bbbbbb;
  --node-group1: #7c3aed;
  --node-group2: #4f46e5;
  --node-group3: #0284c7;
  --node-group4: #7e22ce;
  --node-group5: #2563eb;
  --node-tag: #dddddd;
  --link-color: rgba(0,0,0,0.08);
  --link-hover: rgba(0,0,0,0.4);
  --panel: #ffffff;
  --panel-border: #e0e0e0;
  --shadow: 0 8px 32px rgba(0,0,0,0.1);
  --shadow-sm: 0 2px 12px rgba(0,0,0,0.06);
  --tag-bg: #f0f0f0;
  --tag-text: #888888;
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  width: 100%; height: 100%;
  overflow: hidden;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg);
  color: var(--text);
  transition: background 0.4s, color 0.4s;
}

@keyframes pulse {
  0%   { r: 0; stroke-opacity: 0.6; }
  100% { r: 30; stroke-opacity: 0; }
}
.pulse-ring {
  animation: pulse 2.4s ease-out infinite;
}

/* â”€â”€ Canvas â”€â”€ */
#graph-canvas {
  position: fixed;
  inset: 0;
  width: 100%; height: 100%;
  cursor: grab;
}
#graph-canvas:active { cursor: grabbing; }

/* Subtle radial glow at center */
#graph-canvas::before {
  content: '';
  position: absolute;
  inset: 0;
  background: radial-gradient(ellipse 60% 50% at 50% 50%, var(--accent-glow), transparent 70%);
  pointer-events: none;
}

/* â”€â”€ Bottom bar: legend + actions â”€â”€ */
#legend {
  position: fixed;
  bottom: 18px; left: 50%;
  transform: translateX(-50%);
  display: flex; align-items: center; gap: 6px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 12px;
  padding: 8px 14px;
  z-index: 20;
  backdrop-filter: blur(8px);
  box-shadow: var(--shadow-sm);
  flex-wrap: wrap;
  justify-content: center;
}

#bottom-actions {
  position: fixed;
  bottom: 18px; right: 18px;
  display: flex; align-items: center; gap: 8px;
  z-index: 20;
}

.topbar-btn {
  display: flex; align-items: center; gap: 6px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  color: var(--text-muted);
  border-radius: 7px;
  padding: 5px 12px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
  backdrop-filter: blur(8px);
  box-shadow: var(--shadow-sm);
}
.topbar-btn:hover { border-color: var(--accent); color: var(--accent); }
.topbar-btn.icon-only { padding: 5px 8px; }
.legend-item {
  display: flex; align-items: center; gap: 5px;
  font-size: 11px; color: var(--text-muted);
  cursor: pointer;
  padding: 3px 8px;
  border-radius: 6px;
  border: 1px solid transparent;
  transition: all 0.15s;
  user-select: none;
}
.legend-item:hover { border-color: var(--border2); color: var(--text); }
.legend-item.active { border-color: var(--accent); background: var(--accent-glow); color: var(--text); }
.legend-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}
.legend-sep { width: 1px; height: 18px; background: var(--border); }

/* â”€â”€ Node tooltip / info panel â”€â”€ */
#info-panel-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(3px);
  z-index: 50;
  display: none;
  align-items: center;
  justify-content: center;
}
#info-panel-overlay.visible { display: flex; }

#info-panel {
  width: 320px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 18px;
  padding: 24px;
  z-index: 51;
  box-shadow: var(--shadow);
  position: relative;
  animation: panelPop 0.22s ease;
}

@keyframes panelPop {
  from { opacity: 0; transform: scale(0.94) translateY(10px); }
  to   { opacity: 1; transform: scale(1) translateY(0); }
}

.panel-close {
  position: absolute;
  top: 12px; right: 12px;
  background: var(--surface2);
  border: 1px solid var(--border);
  width: 24px; height: 24px;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  font-size: 11px;
  color: var(--text-muted);
  transition: all 0.15s;
}
.panel-close:hover { color: var(--text); border-color: var(--border2); }

.panel-favicon {
  width: 32px; height: 32px;
  border-radius: 8px;
  background: var(--surface2);
  display: flex; align-items: center; justify-content: center;
  font-size: 14px;
  margin-bottom: 10px;
  overflow: hidden;
}
.panel-favicon img { width: 100%; height: 100%; object-fit: contain; }

.panel-title {
  font-family: 'Lora', serif;
  font-size: 17px;
  font-weight: 600;
  line-height: 1.3;
  margin-bottom: 4px;
  color: var(--text);
}

.panel-url {
  font-size: 10px;
  color: var(--text-muted);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  margin-bottom: 10px;
}

.panel-note {
  font-family: 'Lora', serif;
  font-style: italic;
  font-size: 13px;
  color: var(--text-muted);
  line-height: 1.5;
  margin-bottom: 10px;
  padding: 8px 10px;
  background: var(--surface2);
  border-radius: 7px;
  border-left: 2px solid var(--accent);
}

.panel-tags {
  display: flex; flex-wrap: wrap; gap: 5px;
  margin-bottom: 14px;
}
.ptag {
  font-size: 10px;
  background: var(--tag-bg);
  color: var(--tag-text);
  border-radius: 4px;
  padding: 2px 8px;
}
.ptag::before { content: ''; }

.panel-actions {
  display: flex; flex-direction: column; gap: 8px;
}
.panel-actions-row {
  display: flex; gap: 8px;
}
.panel-btn {
  flex: 1;
  padding: 7px;
  border-radius: 7px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  display: block;
  transition: all 0.15s;
}
.panel-btn:hover { border-color: var(--border2); color: var(--text); }
.panel-btn.primary {
  background: var(--accent);
  border-color: var(--accent);
  color: #fff;
  padding: 13px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.3px;
  border-radius: 10px;
}
.panel-btn.primary:hover { opacity: 0.85; }
.panel-btn.danger:hover { border-color: #f76a8a; color: #f76a8a; }

/* â”€â”€ Yandex Search Modal â”€â”€ */
.ya-modal {
  max-width: 480px;
  padding: 32px 28px 24px;
  text-align: center;
}
.ya-logo-wrap {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  margin-bottom: 22px;
}
.ya-title {
  font-family: 'Lora', serif;
  font-size: 22px;
  font-weight: 600;
  color: var(--text);
  letter-spacing: 0.5px;
}
.ya-search-wrap {
  display: flex;
  gap: 0;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 12px;
  overflow: hidden;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.ya-search-wrap:focus-within {
  border-color: #a78bfa;
  box-shadow: 0 0 0 3px rgba(167,139,250,0.15);
}
.ya-search-wrap input {
  flex: 1;
  background: transparent;
  border: none;
  outline: none;
  padding: 13px 16px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 15px;
}
.ya-search-wrap input::placeholder { color: var(--text-muted); }
#yaGo {
  background: #a78bfa;
  border: none;
  padding: 0 20px;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
  transition: background 0.18s;
  font-family: 'JetBrains Mono', monospace;
}
#yaGo:hover { background: #8b70f5; }
.ya-hint {
  margin-top: 12px;
  font-size: 10px;
  color: var(--text-dim);
  letter-spacing: 0.5px;
}

/* â”€â”€ Modal â”€â”€ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.75);
  backdrop-filter: blur(5px);
  z-index: 100;
  display: flex; align-items: center; justify-content: center;
  opacity: 0; pointer-events: none;
  transition: opacity 0.2s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }

.modal {
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 18px;
  padding: 28px;
  width: 100%; max-width: 440px;
  box-shadow: 0 24px 80px rgba(0,0,0,0.6);
  transform: translateY(16px) scale(0.98);
  transition: transform 0.25s;
}
.modal-overlay.open .modal { transform: none; }

.modal h3 {
  font-family: 'Lora', serif;
  font-size: 20px;
  margin-bottom: 22px;
}

.field { margin-bottom: 14px; }
.field label {
  display: block;
  font-size: 10px; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--text-muted);
  margin-bottom: 6px;
}
.field input, .field textarea, .field select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 8px 12px;
  color: var(--text);
  font-family: 'JetBrains Mono', monospace;
  font-size: 13px;
  outline: none;
  transition: border-color 0.2s, box-shadow 0.2s;
  resize: vertical;
}
.field input:focus, .field textarea:focus, .field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 2px var(--accent-glow);
}
.field select option { background: var(--surface); }

.modal-btns {
  display: flex; justify-content: flex-end; gap: 10px;
  margin-top: 22px;
}
.btn {
  padding: 8px 20px;
  border-radius: 8px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 12px;
  cursor: pointer;
  border: 1px solid var(--border);
  transition: all 0.18s;
}
.btn-secondary { background: transparent; color: var(--text-muted); }
.btn-secondary:hover { color: var(--text); border-color: var(--border2); }
.btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; font-weight: 600; }
.btn-primary:hover { opacity: 0.85; }

/* â”€â”€ Node count badge â”€â”€ */
#stats {
  position: fixed;
  top: 60px; left: 18px;
  font-size: 11px;
  color: var(--text-dim);
  z-index: 20;
  line-height: 1.8;
  pointer-events: none;
}

/* â”€â”€ Controls â”€â”€ */
#zoom-controls {
  position: fixed;
  bottom: 70px; right: 18px;
  display: flex; flex-direction: column; gap: 5px;
  z-index: 20;
}
.zoom-btn {
  width: 32px; height: 32px;
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 7px;
  color: var(--text-muted);
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: all 0.15s;
}
.zoom-btn:hover { color: var(--accent); border-color: var(--accent); }
</style>
</head>
<body>

<!-- Graph canvas -->
<svg id="graph-canvas"></svg>

<!-- Info panel (centered) -->
<div id="info-panel-overlay">
  <div id="info-panel">
    <div class="panel-close" id="panelClose">âœ•</div>
    <div class="panel-favicon" id="panelFav"></div>
    <div class="panel-title" id="panelTitle"></div>
    <div class="panel-url" id="panelUrl"></div>
    <div class="panel-note" id="panelNote" style="display:none"></div>
    <div class="panel-tags" id="panelTags"></div>
    <div class="panel-actions">
      <a class="panel-btn primary" id="panelOpen" target="_blank">â†’ ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ</a>
      <div class="panel-actions-row">
        <button class="panel-btn" id="panelEdit">âœ Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ</button>
        <button class="panel-btn danger" id="panelDel">âœ• Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ</button>
      </div>
    </div>
  </div>
</div>

<!-- Stats -->
<div id="stats"></div>

<!-- Zoom controls -->
<div id="zoom-controls">
  <button class="zoom-btn" id="zoomIn">ï¼‹</button>
  <button class="zoom-btn" id="zoomReset">â—</button>
  <button class="zoom-btn" id="zoomOut">ï¼</button>
</div>

<!-- Legend + controls bottom bar -->
<div id="legend"></div>

<!-- Bottom action buttons -->
<div id="bottom-actions">
  <button class="topbar-btn icon-only" id="themeToggle" title="Ğ¢ĞµĞ¼Ğ°">â˜€ï¸</button>
  <button class="topbar-btn" id="addBookmarkBtn">ï¼‹ Ğ—Ğ°ĞºĞ»Ğ°Ğ´ĞºĞ°</button>
  <button class="topbar-btn icon-only" id="addGroupBtn" title="ĞĞ¾Ğ²Ğ°Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°">âŠ</button>
</div>

<!-- Ğ¯Ğ½Ğ´ĞµĞºÑ Ğ¿Ğ¾Ğ¸ÑĞº -->
<div class="modal-overlay" id="yaSearchOverlay">
  <div class="modal ya-modal">
    <div class="ya-logo-wrap">
      <svg viewBox="0 0 40 48" width="32" height="38" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M24 2H21C14.4 2 10 6.2 10 13.8C10 19.8 12.8 23.4 17.6 26.4L21 28.4L10 46H16L26.8 28.8L22.4 26.2C17.8 23.4 15.8 20.4 15.8 13.8C15.8 8.6 18.6 6.6 21.6 6.6H24V46H29.6V2H24Z" fill="#a78bfa"/>
      </svg>
      <span class="ya-title">Ğ¯Ğ½Ğ´ĞµĞºÑ</span>
    </div>
    <div class="ya-search-wrap">
      <input type="text" id="yaQuery" placeholder="ĞŸĞ¾Ğ¸ÑĞº Ğ² Ğ¯Ğ½Ğ´ĞµĞºÑĞµ..." autocomplete="off" spellcheck="false">
      <button id="yaGo">â†’</button>
    </div>
    <div class="ya-hint">Enter Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Â· Esc Ğ´Ğ»Ñ Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ</div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <h3 id="modalTitle">ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°ĞºĞ»Ğ°Ğ´ĞºĞ°</h3>
    <div class="field"><label>ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ</label><input type="text" id="fTitle" placeholder="ĞœĞ¾Ğ¹ ÑĞ°Ğ¹Ñ‚"></div>
    <div class="field"><label>URL</label><input type="url" id="fUrl" placeholder="https://..."></div>
    <div class="field"><label>Ğ—Ğ°Ğ¼ĞµÑ‚ĞºĞ° (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)</label><textarea id="fNote" rows="2" placeholder="ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ..."></textarea></div>
    <div class="field"><label>Ğ¢ĞµĞ³Ğ¸ (Ñ‡ĞµÑ€ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±ĞµĞ»)</label><input type="text" id="fTags" placeholder="Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚"></div>
    <div class="field"><label>Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°</label><select id="fGroup"></select></div>
    <div class="modal-btns">
      <button class="btn btn-secondary" id="modalCancel">ĞÑ‚Ğ¼ĞµĞ½Ğ°</button>
      <button class="btn btn-primary" id="modalSave">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DEFAULT = {
  groups: [
    { id: 'g1', name: 'Ğ•Ğ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğµ' },
    { id: 'g3', name: 'ĞœĞµĞ´Ğ¸Ğ°' },
    { id: 'g4', name: 'Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½' },
    { id: 'g5', name: 'ĞĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚Ğ¸' },
  ],
  bookmarks: [
    { id:'b0',  groupId:null,  title:'Ğ¯Ğ½Ğ´ĞµĞºÑ',          url:'https://ya.ru/',                  note:'ĞŸĞ¾Ğ¸ÑĞº',               tags:[],                              hub:true },
    { id:'b1',  groupId:'g1', title:'Gmail',          url:'https://mail.google.com',         note:'Ğ Ğ°Ğ±Ğ¾Ñ‡Ğ°Ñ Ğ¿Ğ¾Ñ‡Ñ‚Ğ°',       tags:['Ğ¿Ğ¾Ñ‡Ñ‚Ğ°','google'],              priority:true },
    { id:'b3',  groupId:'g1', title:'Telegram Web',    url:'https://web.telegram.org',        note:'',                    tags:['Ñ‡Ğ°Ñ‚','Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€'] },
    { id:'b9',  groupId:'g3', title:'YouTube',         url:'https://youtube.com',             note:'Ğ’Ğ¸Ğ´ĞµĞ¾',               tags:['Ğ²Ğ¸Ğ´ĞµĞ¾','Ğ¼ĞµĞ´Ğ¸Ğ°'],               priority:true },
    { id:'b11', groupId:'g4', title:'Dribbble',        url:'https://dribbble.com',            note:'Ğ”Ğ¸Ğ·Ğ°Ğ¹Ğ½-Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ',  tags:['Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½','Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ'] },
    { id:'b12', groupId:'g4', title:'Figma',           url:'https://figma.com',               note:'UI-Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½',           tags:['Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½','Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚'] },
    { id:'b13', groupId:'g4', title:'Behance',         url:'https://behance.net',             note:'ĞŸĞ¾Ñ€Ñ‚Ñ„Ğ¾Ğ»Ğ¸Ğ¾ Ğ¸ ĞºĞµĞ¹ÑÑ‹',   tags:['Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½','Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ'] },
    { id:'b14', groupId:'g1', title:'Ozon',            url:'https://ozon.ru',                 note:'Ğ˜Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚-Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½',    tags:['ÑˆĞ¾Ğ¿Ğ¸Ğ½Ğ³','Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹Ñ'] },
    { id:'b15', groupId:'g1', title:'Wildberries',     url:'https://wildberries.ru',          note:'ĞœĞ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹Ñ',         tags:['ÑˆĞ¾Ğ¿Ğ¸Ğ½Ğ³','Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹Ñ'] },
    { id:'b16', groupId:'g3', title:'Ğ¯Ğ½Ğ´ĞµĞºÑ ĞœÑƒĞ·Ñ‹ĞºĞ°',   url:'https://music.yandex.ru',         note:'ĞœÑƒĞ·Ñ‹ĞºĞ° Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ°ÑÑ‚Ñ‹',   tags:['Ğ¼ÑƒĞ·Ñ‹ĞºĞ°','Ğ¼ĞµĞ´Ğ¸Ğ°'],              priority:true },
    { id:'b17', groupId:'g3', title:'Journal TOP',     url:'https://journal.top-academy.ru',  note:'Ğ‘Ğ»Ğ¾Ğ³ IT-Ğ°ĞºĞ°Ğ´ĞµĞ¼Ğ¸Ğ¸',    tags:['Ğ¼ĞµĞ´Ğ¸Ğ°','ÑÑ‚Ğ°Ñ‚ÑŒĞ¸','Ğ¾Ğ±ÑƒÑ‡ĞµĞ½Ğ¸Ğµ'],   priority:true },
    { id:'b18', groupId:'g4', title:'Pinterest',       url:'https://pinterest.com',           note:'Ğ˜Ğ´ĞµĞ¸ Ğ¸ Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ',  tags:['Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½','Ğ²Ğ´Ğ¾Ñ…Ğ½Ğ¾Ğ²ĞµĞ½Ğ¸Ğµ','Ñ„Ğ¾Ñ‚Ğ¾'] },
    { id:'b19', groupId:'g1', title:'Ğ¯Ğ½Ğ´ĞµĞºÑ Ğ”Ğ¸ÑĞº',     url:'https://disk.yandex.ru',          note:'ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ğ¾Ğµ Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ',  tags:['Ñ…Ñ€Ğ°Ğ½Ğ¸Ğ»Ğ¸Ñ‰Ğµ','ÑĞ½Ğ´ĞµĞºÑ'] },
    { id:'b20', groupId:'g1', title:'WhatsApp Web',    url:'https://web.whatsapp.com',        note:'ĞœĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€',          tags:['Ñ‡Ğ°Ñ‚','Ğ¼ĞµÑÑĞµĞ½Ğ´Ğ¶ĞµÑ€'] },
    { id:'b21', groupId:'g5', title:'ChatGPT',         url:'https://chatgpt.com',             note:'GPT-4o Ğ¾Ñ‚ OpenAI',    tags:['Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚ÑŒ','Ñ‡Ğ°Ñ‚'] },
    { id:'b22', groupId:'g5', title:'Leonardo',        url:'https://leonardo.ai',             note:'Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹', tags:['Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚ÑŒ','Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ'] },
    { id:'b23', groupId:'g5', title:'Qwen',            url:'https://chat.qwen.ai',            note:'Ğ˜Ğ˜ Ğ¾Ñ‚ Alibaba',       tags:['Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚ÑŒ','Ñ‡Ğ°Ñ‚'] },
    { id:'b24', groupId:'g5', title:'Claude',          url:'https://claude.ai',               note:'Ğ˜Ğ˜ Ğ¾Ñ‚ Anthropic',     tags:['Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚ÑŒ','Ñ‡Ğ°Ñ‚'] },
  ]
};

let data = (() => { try { return JSON.parse(localStorage.getItem('vaulttab_g') || 'null') || DEFAULT; } catch { return DEFAULT; } })();
let editingId = null;
let selectedNodeId = null;
let activeFilter = null; // group id filter

function save() { localStorage.setItem('vaulttab_g', JSON.stringify(data)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  THEME & CLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const themeBtn = document.getElementById('themeToggle');
function setTheme(t) {
  document.documentElement.dataset.theme = t;
  themeBtn.textContent = t === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
  localStorage.setItem('vt_theme_g', t);
  // Re-render graph colors
  if (window._simulation) rebuildGraph('');
}
setTheme(localStorage.getItem('vt_theme_g') || 'dark');
themeBtn.addEventListener('click', () => setTheme(document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark'));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GROUP COLORS (CSS var names)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GROUP_COLORS = ['--node-group1','--node-group2','--node-group3','--node-group4','--node-group5'];
function groupColor(gid) {
  if (!gid) return '#a78bfa';
  const i = data.groups.findIndex(g => g.id === gid);
  const varName = GROUP_COLORS[i % GROUP_COLORS.length];
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}
function tagColor() {
  return getComputedStyle(document.documentElement).getPropertyValue('--border2').trim();
}
function linkColor() {
  return getComputedStyle(document.documentElement).getPropertyValue('--link-color').trim();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FAVICON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function faviconSrc(url) {
  try { return `https://www.google.com/s2/favicons?sz=32&domain=${new URL(url).hostname}`; } catch { return ''; }
}
function hostname(url) {
  try { return new URL(url).hostname.replace(/^www\./, ''); } catch { return url; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEGEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLegend() {
  const leg = document.getElementById('legend');
  leg.innerHTML = `<span class="legend-item ${!activeFilter?'active':''}" data-filter="">
    <span class="legend-dot" style="background:var(--text-dim)"></span>Ğ’ÑĞµ
  </span><span class="legend-sep"></span>` +
  data.groups.map((g,i) => {
    const col = getComputedStyle(document.documentElement).getPropertyValue(GROUP_COLORS[i%GROUP_COLORS.length]).trim();
    return `<span class="legend-item ${activeFilter===g.id?'active':''}" data-filter="${g.id}">
      <span class="legend-dot" style="background:${col}"></span>${g.name}
    </span>`;
  }).join('') +
  `<span class="legend-sep"></span><span class="legend-item" style="cursor:default;opacity:0.5">
    <span class="legend-dot" style="background:var(--border2);border-radius:2px"></span>Ğ¢ĞµĞ³
  </span>`;

  leg.querySelectorAll('[data-filter]').forEach(el => {
    el.addEventListener('click', () => {
      activeFilter = el.dataset.filter || null;
      renderLegend();
      rebuildGraph('');
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GRAPH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let svgEl, gEl, zoomBehavior;

function initSvg() {
  svgEl = d3.select('#graph-canvas');
  svgEl.selectAll('*').remove();

  // Defs: glow filter (colored) + white glow for hover
  const defs = svgEl.append('defs');
  const filter = defs.append('filter').attr('id','glow').attr('x','-50%').attr('y','-50%').attr('width','200%').attr('height','200%');
  filter.append('feGaussianBlur').attr('stdDeviation','3').attr('result','coloredBlur');
  const feMerge = filter.append('feMerge');
  feMerge.append('feMergeNode').attr('in','coloredBlur');
  feMerge.append('feMergeNode').attr('in','SourceGraphic');

  // White glow filter for hover
  const filterW = defs.append('filter').attr('id','glow-white').attr('x','-80%').attr('y','-80%').attr('width','260%').attr('height','260%');
  filterW.append('feGaussianBlur').attr('stdDeviation','6').attr('result','wb');
  const feMergeW = filterW.append('feMerge');
  feMergeW.append('feMergeNode').attr('in','wb');
  feMergeW.append('feMergeNode').attr('in','SourceGraphic');

  gEl = svgEl.append('g').attr('class','graph-root');

  zoomBehavior = d3.zoom()
    .scaleExtent([0.2, 4])
    .on('zoom', (event) => gEl.attr('transform', event.transform));

  svgEl.call(zoomBehavior);

  // Zoom controls
  document.getElementById('zoomIn').onclick = () => svgEl.transition().duration(300).call(zoomBehavior.scaleBy, 1.4);
  document.getElementById('zoomOut').onclick = () => svgEl.transition().duration(300).call(zoomBehavior.scaleBy, 0.7);
  document.getElementById('zoomReset').onclick = () => svgEl.transition().duration(400).call(zoomBehavior.transform, d3.zoomIdentity);
}

function rebuildGraph(query = '') {
  const W = window.innerWidth, H = window.innerHeight;
  const q = query.toLowerCase();

  // Filter bookmarks
  let bms = data.bookmarks;
  if (activeFilter) bms = bms.filter(b => b.groupId === activeFilter);
  if (q) bms = bms.filter(b =>
    b.title.toLowerCase().includes(q) ||
    b.url.toLowerCase().includes(q) ||
    (b.note||'').toLowerCase().includes(q) ||
    b.tags.some(t => t.toLowerCase().includes(q))
  );

  // Hub node always present (Ğ¯Ğ½Ğ´ĞµĞºÑ), not filtered
  const hubBm = data.bookmarks.find(b => b.hub);
  const regularBms = bms.filter(b => !b.hub);

  // Collect unique tags
  const tagSet = new Set();
  regularBms.forEach(b => b.tags.forEach(t => tagSet.add(t)));
  const tags = [...tagSet];

  // Build nodes â€” hub fixed at center
  const HUB_R = 32;
  const nodes = [
    ...(hubBm ? [{ id: hubBm.id, type: 'bookmark', data: hubBm, radius: HUB_R, fx: W / 2, fy: H / 2 }] : []),
    ...regularBms.map(b => ({ id: b.id, type: 'bookmark', data: b, radius: b.priority ? 17 : 10 + Math.min(b.tags.length, 3) })),
    ...tags.map(t => ({ id: 'tag:'+t, type: 'tag', label: t, radius: 5 })),
  ];

  // Build links
  const links = [];
  bms.forEach(b => {
    b.tags.forEach(t => {
      if (tagSet.has(t)) links.push({ source: b.id, target: 'tag:'+t });
    });
  });

  // Update stats
  document.getElementById('stats').innerHTML = `${bms.length} Ğ·Ğ°ĞºĞ»Ğ°Ğ´Ğ¾Ğº Â· ${tags.length} Ñ‚ĞµĞ³Ğ¾Ğ²`;

  // Stop old simulation
  if (window._simulation) window._simulation.stop();

  // Clear graph
  gEl.selectAll('*').remove();

  // Link layer
  const linkEls = gEl.append('g').attr('class','links')
    .selectAll('line').data(links).enter().append('line')
    .attr('stroke', linkColor())
    .attr('stroke-width', 1)
    .attr('stroke-opacity', 0.8);

  // Node groups
  const nodeGroups = gEl.append('g').attr('class','nodes')
    .selectAll('g').data(nodes).enter().append('g')
    .attr('class', d => `node node-${d.type}`)
    .style('cursor', d => d.type === 'bookmark' ? 'pointer' : 'default')
    .call(d3.drag()
      .on('start', (event, d) => {
        if (!event.active) window._simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      })
      .on('drag', (event, d) => { d.fx = event.x; d.fy = event.y; })
      .on('end', (event, d) => {
        if (!event.active) window._simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
      })
    );

  // â”€â”€ Hub node (Ğ¯Ğ½Ğ´ĞµĞºÑ) â€” Ğ»Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿, hover-scale, Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ ĞºĞ»Ğ¸ĞºÑƒ â”€â”€
  const hubGroup = nodeGroups.filter(d => d.data && d.data.hub);

  // Outer slow pulse ring
  hubGroup.append('circle')
    .attr('class', 'pulse-ring')
    .attr('r', HUB_R + 12)
    .attr('fill', 'none')
    .attr('stroke', '#a78bfa')
    .attr('stroke-width', 1)
    .attr('stroke-opacity', 0.35)
    .attr('pointer-events', 'none')
    .style('animation', 'pulse 3.2s ease-out infinite');

  hubGroup.append('circle')
    .attr('class', 'pulse-ring')
    .attr('r', HUB_R + 7)
    .attr('fill', 'none')
    .attr('stroke', '#c4b5fd')
    .attr('stroke-width', 1.5)
    .attr('stroke-opacity', 0.55)
    .attr('pointer-events', 'none')
    .style('animation', 'pulse 2.2s ease-out infinite 0.6s');

  // Core circle (the hoverable/scaleable part â€” class hub-core)
  hubGroup.append('circle')
    .attr('class', 'hub-core')
    .attr('r', HUB_R)
    .attr('fill', '#0d0821')
    .attr('filter', 'url(#glow)')
    .attr('stroke', '#a78bfa')
    .attr('stroke-width', 2)
    .attr('stroke-opacity', 0.85);

  // Ğ¯Ğ½Ğ´ĞµĞºÑ SVG logo via foreignObject
  hubGroup.append('foreignObject')
    .attr('class', 'hub-logo')
    .attr('width', HUB_R * 1.4)
    .attr('height', HUB_R * 1.4)
    .attr('x', -HUB_R * 0.7)
    .attr('y', -HUB_R * 0.7)
    .attr('pointer-events', 'none')
    .html(`<div xmlns="http://www.w3.org/1999/xhtml" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
      <svg viewBox="0 0 24 24" width="${HUB_R*1.1}" height="${HUB_R*1.1}" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M14.4 2H12.8C9.6 2 7.6 3.8 7.6 7.2C7.6 10.0 9.0 11.6 11.4 13.2L13.0 14.2L7.4 22H9.6L15.0 14.6L13.2 13.4C11.0 12.0 9.8 10.6 9.8 7.2C9.8 4.8 11.2 3.8 13.0 3.8H14.4V22H16.4V2H14.4Z" fill="#a78bfa"/>
      </svg>
    </div>`);

  // Hub label below
  hubGroup.append('text')
    .attr('class', 'hub-label')
    .text('Ğ¯Ğ½Ğ´ĞµĞºÑ')
    .attr('dy', HUB_R + 16)
    .attr('text-anchor', 'middle')
    .attr('fill', '#c4b5fd')
    .attr('font-size', '12px')
    .attr('font-weight', '700')
    .attr('font-family', 'JetBrains Mono, monospace')
    .attr('letter-spacing', '1.5px')
    .attr('pointer-events', 'none');

  // Hub hover: scale up + white glow stroke
  hubGroup
    .on('mouseenter', function() {
      d3.select(this).select('.hub-core')
        .transition().duration(300).ease(d3.easeCubicOut)
        .attr('r', HUB_R * 1.25)
        .attr('stroke', '#ffffff')
        .attr('stroke-width', 3)
        .attr('stroke-opacity', 0.8)
        .attr('filter', 'url(#glow-white)');
      d3.select(this).select('.hub-logo')
        .transition().duration(300).ease(d3.easeCubicOut)
        .attr('width', HUB_R * 1.4 * 1.25)
        .attr('height', HUB_R * 1.4 * 1.25)
        .attr('x', -HUB_R * 0.7 * 1.25)
        .attr('y', -HUB_R * 0.7 * 1.25);
      d3.select(this).select('.hub-label')
        .transition().duration(300)
        .attr('dy', HUB_R * 1.25 + 17)
        .attr('fill', '#ffffff');
    })
    .on('mouseleave', function() {
      d3.select(this).select('.hub-core')
        .transition().duration(420).ease(d3.easeElasticOut.amplitude(1).period(0.4))
        .attr('r', HUB_R)
        .attr('stroke', '#a78bfa')
        .attr('stroke-width', 2)
        .attr('stroke-opacity', 0.85)
        .attr('filter', 'url(#glow)');
      d3.select(this).select('.hub-logo')
        .transition().duration(300).ease(d3.easeCubicOut)
        .attr('width', HUB_R * 1.4)
        .attr('height', HUB_R * 1.4)
        .attr('x', -HUB_R * 0.7)
        .attr('y', -HUB_R * 0.7);
      d3.select(this).select('.hub-label')
        .transition().duration(300)
        .attr('dy', HUB_R + 16)
        .attr('fill', '#c4b5fd');
    });

  // Priority nodes: outer pulsing ring (non-hub only)
  nodeGroups.filter(d => d.type === 'bookmark' && d.data.priority && !d.data.hub)
    .append('circle')
    .attr('class', 'pulse-ring')
    .attr('r', d => d.radius + 5)
    .attr('fill', 'none')
    .attr('stroke', d => groupColor(d.data.groupId))
    .attr('stroke-width', 1.5)
    .attr('stroke-opacity', 0.5)
    .attr('pointer-events', 'none');

  // Bookmark nodes â€” pastel fill, subtle stroke (non-hub)
  nodeGroups.filter(d => d.type === 'bookmark' && !d.data.hub)
    .append('circle')
    .attr('class', 'node-fill')
    .attr('r', d => d.radius)
    .attr('fill', d => groupColor(d.data.groupId))
    .attr('fill-opacity', d => d.data.priority ? 1 : 0.7)
    .attr('filter', 'url(#glow)')
    .attr('stroke', '#ffffff')
    .attr('stroke-width', d => d.data.priority ? 2 : 1)
    .attr('stroke-opacity', d => d.data.priority ? 0.5 : 0.12);

  // Tag nodes (diamond shape via rect rotated)
  nodeGroups.filter(d => d.type === 'tag')
    .append('rect')
    .attr('width', d => d.radius * 1.6)
    .attr('height', d => d.radius * 1.6)
    .attr('x', d => -d.radius * 0.8)
    .attr('y', d => -d.radius * 0.8)
    .attr('transform', 'rotate(45)')
    .attr('fill', () => tagColor())
    .attr('fill-opacity', 0.9)
    .attr('stroke', () => {
      const c = getComputedStyle(document.documentElement).getPropertyValue('--text-dim').trim();
      return c;
    })
    .attr('stroke-width', 1);

  // Labels for bookmarks (non-hub)
  nodeGroups.filter(d => d.type === 'bookmark' && !d.data.hub)
    .append('text')
    .attr('class', 'node-label')
    .text(d => d.data.title)
    .attr('dy', d => d.radius + 13)
    .attr('text-anchor', 'middle')
    .attr('fill', d => d.data.priority
      ? getComputedStyle(document.documentElement).getPropertyValue('--text').trim()
      : getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim())
    .attr('font-size', d => d.data.priority ? '12px' : '10px')
    .attr('font-weight', d => d.data.priority ? '600' : '400')
    .attr('font-family', 'JetBrains Mono, monospace')
    .attr('letter-spacing', d => d.data.priority ? '0.3px' : '0')
    .attr('pointer-events', 'none');

  // Labels for tags
  nodeGroups.filter(d => d.type === 'tag')
    .append('text')
    .text(d => d.label)
    .attr('dy', d => d.radius + 13)
    .attr('text-anchor', 'middle')
    .attr('fill', () => getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim())
    .attr('font-size', '10px')
    .attr('font-family', 'JetBrains Mono, monospace')
    .attr('pointer-events', 'none');

  // Hover effects â€” Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ğ¾Ğµ Ğ±ĞµĞ»Ğ¾Ğµ ÑĞ²ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ Ğ²ÑĞµÑ… (non-hub)
  nodeGroups.filter(d => d.type === 'bookmark' && !d.data.hub)
    .on('mouseenter', function(event, d) {
      d3.select(this).select('.node-fill')
        .transition().duration(300).ease(d3.easeCubicOut)
        .attr('r', d.radius * 1.85)
        .attr('fill', '#ffffff')
        .attr('fill-opacity', 1)
        .attr('stroke', '#ffffff')
        .attr('stroke-opacity', 0.9)
        .attr('stroke-width', 2.5)
        .attr('filter', 'url(#glow-white)');
      d3.select(this).select('.node-label')
        .transition().duration(300).ease(d3.easeCubicOut)
        .attr('dy', d.radius * 1.85 + 14)
        .attr('fill', '#ffffff')
        .attr('font-size', '12px');
      linkEls
        .transition().duration(180)
        .attr('stroke', l => (l.source.id === d.id || l.target.id === d.id)
          ? 'rgba(255,255,255,0.6)' : linkColor())
        .attr('stroke-width', l => (l.source.id === d.id || l.target.id === d.id) ? 2 : 1)
        .attr('stroke-opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.4);
    })
    .on('mouseleave', function(event, d) {
      const origColor = groupColor(d.data.groupId);
      d3.select(this).select('.node-fill')
        .transition().duration(450).ease(d3.easeElasticOut.amplitude(1).period(0.45))
        .attr('r', d.radius)
        .attr('fill', origColor)
        .attr('fill-opacity', d.data.priority ? 1 : 0.7)
        .attr('stroke', '#ffffff')
        .attr('stroke-opacity', d.data.priority ? 0.5 : 0.12)
        .attr('stroke-width', d.data.priority ? 2 : 1)
        .attr('filter', 'url(#glow)');
      d3.select(this).select('.node-label')
        .transition().duration(280).ease(d3.easeCubicOut)
        .attr('dy', d.radius + 13)
        .attr('fill', d.data.priority
          ? getComputedStyle(document.documentElement).getPropertyValue('--text').trim()
          : getComputedStyle(document.documentElement).getPropertyValue('--text-muted').trim())
        .attr('font-size', d.data.priority ? '12px' : '10px');
      linkEls
        .transition().duration(220)
        .attr('stroke', linkColor())
        .attr('stroke-width', 1)
        .attr('stroke-opacity', 0.8);
    })
    .on('click', (event, d) => {
      event.stopPropagation();
      showPanel(d.data.id);
    });

  // Hub click â†’ Yandex search
  hubGroup.style('cursor', 'pointer')
    .on('click', (event) => { event.stopPropagation(); openYaSearch(); });

  // Click on SVG = close panel
  svgEl.on('click', () => closePanel());

  // Force simulation â€” ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾, Ğ²ÑÑ‘ Ğ²Ğ»ĞµĞ·Ğ°ĞµÑ‚ Ğ½Ğ° ÑĞºÑ€Ğ°Ğ½
  window._simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(70).strength(0.6))
    .force('charge', d3.forceManyBody().strength(-130))
    .force('center', d3.forceCenter(W / 2, H / 2))
    .force('collision', d3.forceCollide(d => d.radius + 16))
    .force('x', d3.forceX(W / 2).strength(0.02))
    .force('y', d3.forceY(H / 2).strength(0.025))
    .on('tick', () => {
      linkEls
        .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
      nodeGroups.attr('transform', d => `translate(${d.x},${d.y})`);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INFO PANEL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPanel(id) {
  const bm = data.bookmarks.find(b => b.id === id);
  if (!bm) return;
  selectedNodeId = id;

  const fav = faviconSrc(bm.url);
  document.getElementById('panelFav').innerHTML = fav
    ? `<img src="${fav}" onerror="this.parentNode.textContent='ğŸ”—'">`
    : 'ğŸ”—';
  document.getElementById('panelTitle').textContent = bm.title;
  document.getElementById('panelUrl').textContent = hostname(bm.url);

  const noteEl = document.getElementById('panelNote');
  if (bm.note) { noteEl.textContent = bm.note; noteEl.style.display = ''; }
  else noteEl.style.display = 'none';

  document.getElementById('panelTags').innerHTML = bm.tags.map(t => `<span class="ptag">${t}</span>`).join('');
  document.getElementById('panelOpen').href = bm.url;

  document.getElementById('info-panel-overlay').classList.add('visible');
}

function closePanel() {
  document.getElementById('info-panel-overlay').classList.remove('visible');
  selectedNodeId = null;
}

document.getElementById('panelClose').addEventListener('click', closePanel);
document.getElementById('info-panel-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('info-panel-overlay')) closePanel();
});

document.getElementById('panelEdit').addEventListener('click', () => {
  if (selectedNodeId) openEdit(selectedNodeId);
});

document.getElementById('panelDel').addEventListener('click', () => {
  if (!selectedNodeId) return;
  if (confirm('Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ·Ğ°ĞºĞ»Ğ°Ğ´ĞºÑƒ?')) {
    data.bookmarks = data.bookmarks.filter(b => b.id !== selectedNodeId);
    save(); closePanel();
    rebuildGraph('');
    renderLegend();
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  YANDEX SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const yaOverlay = document.getElementById('yaSearchOverlay');
const yaInput = document.getElementById('yaQuery');

function openYaSearch() {
  yaInput.value = '';
  yaOverlay.classList.add('open');
  setTimeout(() => yaInput.focus(), 60);
}
function closeYaSearch() { yaOverlay.classList.remove('open'); }

function doYaSearch() {
  const q = yaInput.value.trim();
  if (!q) return;
  window.open('https://yandex.ru/search/?text=' + encodeURIComponent(q), '_blank');
  closeYaSearch();
}

document.getElementById('yaGo').addEventListener('click', doYaSearch);
yaInput.addEventListener('keydown', e => {
  if (e.key === 'Enter') doYaSearch();
});
yaOverlay.addEventListener('click', e => { if (e.target === yaOverlay) closeYaSearch(); });

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); closePanel(); closeYaSearch(); }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const overlay = document.getElementById('modalOverlay');
function closeModal() { overlay.classList.remove('open'); }

function populateGroups(sel) {
  document.getElementById('fGroup').innerHTML = data.groups
    .map(g => `<option value="${g.id}" ${g.id===sel?'selected':''}>${g.name}</option>`).join('');
}

function openAdd(gid) {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°ĞºĞ»Ğ°Ğ´ĞºĞ°';
  ['fTitle','fUrl','fNote','fTags'].forEach(i => document.getElementById(i).value = '');
  populateGroups(gid || data.groups[0]?.id);
  overlay.classList.add('open');
  document.getElementById('fTitle').focus();
}

function openEdit(id) {
  const bm = data.bookmarks.find(b => b.id === id);
  editingId = id;
  document.getElementById('modalTitle').textContent = 'Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ';
  document.getElementById('fTitle').value = bm.title;
  document.getElementById('fUrl').value = bm.url;
  document.getElementById('fNote').value = bm.note || '';
  document.getElementById('fTags').value = bm.tags.join(' ');
  populateGroups(bm.groupId);
  overlay.classList.add('open');
  document.getElementById('fTitle').focus();
}

document.getElementById('addBookmarkBtn').addEventListener('click', () => openAdd(null));
document.getElementById('modalCancel').addEventListener('click', closeModal);
overlay.addEventListener('click', e => { if (e.target === overlay) closeModal(); });

document.getElementById('modalSave').addEventListener('click', () => {
  const title = document.getElementById('fTitle').value.trim();
  const url = document.getElementById('fUrl').value.trim();
  if (!title || !url) { document.getElementById(title ? 'fUrl' : 'fTitle').focus(); return; }
  const bm = {
    id: editingId || 'b'+Date.now(),
    groupId: document.getElementById('fGroup').value,
    title, url,
    note: document.getElementById('fNote').value.trim(),
    tags: document.getElementById('fTags').value.trim().split(/\s+/).filter(Boolean),
  };
  if (editingId) {
    const i = data.bookmarks.findIndex(b => b.id === editingId);
    data.bookmarks[i] = bm;
  } else {
    data.bookmarks.push(bm);
  }
  save(); closeModal();
  rebuildGraph('');
  renderLegend();
  if (editingId) showPanel(bm.id);
});

document.getElementById('addGroupBtn').addEventListener('click', () => {
  const name = prompt('ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹:');
  if (!name?.trim()) return;
  data.groups.push({ id: 'g'+Date.now(), name: name.trim() });
  save(); renderLegend(); rebuildGraph();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let searchTimer;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize', () => {
  if (window._resizeTimer) clearTimeout(window._resizeTimer);
  window._resizeTimer = setTimeout(() => {
    rebuildGraph('');
  }, 200);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
initSvg();
renderLegend();
rebuildGraph();
</script>
</body>
</html>
